#!/bin/bash

hue() {
  path=$1
  ext=${path##*.}
  file=${path##*/}
  theme=${file%.*}

  printf "ðŸŒ¿  Generating colors...\n"
  get_colors
  printf "ðŸŒ¿  Setting colors...\n"
  set_colors
  printf "ðŸŒ¿  Generating file...\n"
  create_file
  printf "ðŸŒ¿  Opening file...\n"
  open_file


  # print_hex
  # convert_colors
  # print_colors
  # print_256
  # create_file
  # adjust_colors
}

set_colors() {
  black="${colors[0]}"
  grey="${colors[1]}"
  red="${colors[2]}"
  green="${colors[3]}"
  blue="${colors[4]}"
  white="${colors[5]}"
}

open_file() {
  open "$page"
}

create_file() {
  page="$HOME/.hue/themes/$theme/$theme.html"
  mkdir -p "$HOME/.hue/themes/$theme/"
  cp "$path" "$HOME/.hue/themes/$theme/wal.$ext"
  cp html/template.html "$page"

  sed -i '' "s/{{black}}/$black/g" "$page"
  sed -i '' "s/{{grey}}/$grey/g" "$page"
  sed -i '' "s/{{red}}/$red/g" "$page"
  sed -i '' "s/{{green}}/$green/g" "$page"
  sed -i '' "s/{{blue}}/$blue/g" "$page"
  sed -i '' "s/{{white}}/$white/g" "$page"

  sed -i '' "s/{{path}}/wal.jpg/g" "$page"
  sed -i '' "s/{{theme}}/$theme/g" "$page"
}

get_colors() {
  colors=($(convert "$path" +dither -colors 6 -unique-colors txt:- | grep -E -o " \#.{6}"))
}

convert_colors() {
  colors_256=()
  for i in "${!colors[@]}"
  do
    color=${colors[$i]}
    colors_256[$i]=$(hex_to_256 ${color})
  done
}

print_256() {
  printf '%s\n' "${colors_256[@]}"
}

print_hex() {
  printf '%s\n' "${colors[@]}"
}

print_colors() {
  for i in "${!colors[@]}"
  do
    print_color ${colors_256[$i]} ${colors[$i]}
  done
}

print_color() {
  printf '\e[48;5;%sm %s \e[0m\n' $1 $2
}

hex_to_256() {
  hex=${1#'#'}
  r=$(printf '0x%0.2s' "$hex")
  g=$(printf '0x%0.2s' ${hex#??})
  b=$(printf '0x%0.2s' ${hex#????})
  printf '%03d\n' "$(( (r<75?0:(r-35)/40)*6*6 +
                     (g<75?0:(g-35)/40)*6   +
                     (b<75?0:(b-35)/40)     + 16 ))"
}
